// Generated by CoffeeScript 1.7.1
(function() {
  var BAP, TEX, TEXT, TIDES, TRM, TYPES, alert, badge, cline, debug, echo, esc, hbox, help, hline, hrule, info, leading, leavevmode, log, multicolumn, newline, next_cell, next_line, njs_fs, njs_path, paCenter, paCenterGauge, paLeft, paLeftGauge, paRight, paRightGauge, postscript, preamble, read, rpr, thinspace, warn, whisper;

  njs_fs = require('fs');

  njs_path = require('path');

  BAP = require('coffeenode-bitsnpieces');

  TYPES = require('coffeenode-types');

  TEXT = require('coffeenode-text');

  TRM = require('coffeenode-trm');

  rpr = TRM.rpr.bind(TRM);

  badge = 'TIDES/write-tex';

  log = TRM.get_logger('plain', badge);

  info = TRM.get_logger('info', badge);

  whisper = TRM.get_logger('whisper', badge);

  alert = TRM.get_logger('alert', badge);

  debug = TRM.get_logger('debug', badge);

  warn = TRM.get_logger('warn', badge);

  help = TRM.get_logger('help', badge);

  echo = TRM.echo.bind(TRM);

  TEX = require('jizura-xelatex');

  TIDES = require('./main');

  this._draw_curves_with_gm = require('./draw-curves-with-gm');

  read = function(route) {
    return njs_fs.readFileSync(njs_path.join(__dirname, route), {
      encoding: 'utf-8'
    });
  };

  preamble = read('../tex-inputs/preamble.tex');

  postscript = read('../tex-inputs/postscript.tex');

  this._as_integer = function(hint) {
    return parseInt(hint, 10);
  };

  leavevmode = TEX.make_command('leavevmode');

  hbox = TEX.make_command('hbox');

  leading = TEX.make_command('leading');

  multicolumn = TEX.make_multicommand('multicolumn', 3);

  paLeft = TEX.make_multicommand('paLeft', 3);

  paCenter = TEX.make_multicommand('paCenter', 3);

  paRight = TEX.make_multicommand('paRight', 3);

  paLeftGauge = TEX.make_multicommand('paLeftGauge', 3);

  paCenterGauge = TEX.make_multicommand('paCenterGauge', 3);

  paRightGauge = TEX.make_multicommand('paRightGauge', 3);

  hrule = TEX.raw("\n\n\\hrule\n\n");

  hline = TEX.raw("\n\\hline\n");

  cline = TEX.make_command('cline');

  this.new_tabular = TEX.make_environment('tabular');

  next_line = TEX.raw('\\\\\n');

  newline = TEX.raw('\n');

  next_cell = TEX.raw(' & ');

  esc = TEX._escape.bind(TEX);

  thinspace = TEX.raw('$\\thinspace$');

  thinspace = '\u2009';

  this._get_month_name = function(month_nr) {
    var R;
    month_nr = this._as_integer(month_nr);
    R = TIDES.options.get("/values/months/" + (month_nr - 1));
    if (R == null) {
      throw new Error("unable to understand month specification  " + (rpr(month_nr)));
    }
    return R;
  };

  this.format_month_name = function(month_nr) {
    var align_x, align_y, alignment, content, month_name, pa_command, position_x, position_y;
    month_name = this._get_month_name(month_nr);
    month_name = month_name[0].toUpperCase() + month_name.slice(1);

    /* TAINT inefficient to retrieve each time; options should use cache */
    align_x = TIDES.options.get('/values/layout/month/odd/align/x');
    align_y = TIDES.options.get('/values/layout/month/odd/align/y');
    position_x = (TIDES.options.get('/values/layout/month/odd/position/x')) + 'mm';
    position_y = (TIDES.options.get('/values/layout/month/odd/position/y')) + 'mm';
    switch (alignment = align_x) {
      case 'left':
        pa_command = paLeftGauge;
        break;
      case 'center':
        pa_command = paCenterGauge;
        break;
      case 'right':
        pa_command = paRightGauge;
        break;
      default:
        throw new Error("unknown alignment " + (rpr(alignment)));
    }
    content = TEX.new_group([TEX.new_loner('scFont'), TEX.new_loner('large'), TEX.new_command('color', 'DarkRed'), month_name]);
    return pa_command([position_x, position_y, content]);
  };

  this.draw_curves = function(page_nr, dots, handler) {
    return this._draw_curves_with_gm(page_nr, dots, handler);
  };

  this.y_position_from_datetime = function(row_idx, time, module, unit) {
    var value;
    if (unit == null) {
      unit = 'mm';
    }

    /* TAINT use proper units datatype */

    /* TAINT make prescision configurable */
    value = (row_idx + 1) * module;
    value = value.toFixed(2);
    return "" + value + unit;
  };

  this.main = function() {

    /* TAINT must parametrize data source */
    var dots, last_day, last_month, last_year, moon_quarter, page_nr, route, row_idx, rows, wrote_header;
    route = njs_path.join(__dirname, '../tidal-data/Yerseke.txt');
    rows = TEX.new_container([]);
    row_idx = -1;
    dots = [];
    page_nr = 0;
    last_day = null;
    last_month = null;
    last_year = null;
    moon_quarter = null;
    wrote_header = false;
    echo(preamble);
    return TIDES.walk_tidal_records(route, (function(_this) {
      return function(error, trc) {
        var dst, height, hl, line_count, module, moon_symbol, textheight, this_date, this_day, this_month, this_month_tex, this_time, this_year, unit, x_position, y_position;
        if (error != null) {
          throw error;
        }
        if (trc === null) {
          echo(postscript);
          return;
        }
        row_idx += 1;
        this_date = trc['date'];
        this_time = trc['time'];
        this_year = this_date[0], this_month = this_date[1], this_day = this_date[2];
        if (!wrote_header) {
          this_month_tex = _this.format_month_name(this_month);
          echo(TEX.rpr(this_month_tex));
          wrote_header = true;
        }
        if ((moon_quarter = trc['moon-quarter']) != null) {
          if (moon_quarter === 0 || moon_quarter === 2) {

            /* TAINT collect these in a 'newpage' function */
            row_idx = 0;
            page_nr += 1;
            (function(page_nr, dots) {
              if (page_nr < 3) {

                /* TAINT asynchronous handling is missing */
                info("drawing image " + page_nr);
                route = njs_path.join('/tmp', "tides-p" + page_nr + ".png");
                echo("\\paTopLeft*{0mm}{0mm}{\\includegraphics[width=118mm]{" + route + "}}");
                return _this.draw_curves(route, dots, function(error) {
                  info("image " + page_nr + " ok");
                  if (error != null) {
                    throw error;
                  }
                });
              }
            })(page_nr, dots);
            dots = [];
            echo("\\null\\newpage");
          }
        }

        /* TAINT measurements should be defined in options */
        textheight = 178;
        line_count = 62;
        module = textheight / line_count;
        unit = 'mm';
        y_position = _this.y_position_from_datetime(row_idx, this_time, module, unit);

        /* TAINT Unfortunate solution to again ask for moon quarter */
        if (moon_quarter != null) {
          moon_symbol = TIDES.options.get("/values/moon/" + moon_quarter);
          echo("\\paRight{10mm}{" + y_position + "}{" + moon_symbol + "}");
        }
        if (last_day !== this_day) {
          last_day = this_day;

          /* TAINT days y to be adjusted */
          echo("\\paRight{20mm}{" + y_position + "}{" + this_date[1] + "-" + this_date[2] + "}");
        }
        if (last_month !== this_month) {
          last_month = this_month;
          echo("\\typeout{\\trmSolCyan{" + (this_date.join('-')) + "}}");
        }
        hl = trc['hl'];
        height = trc['height'];
        dots.push([hl, [height, dots.length]]);
        switch (hl) {
          case 'h':
            x_position = '40mm';
            break;
          case 'l':
            x_position = '90mm';
            break;
          default:
            throw new Error("expected `h` or `l` for hl indicator, got " + (rpr(hl)));
        }

        /* TAINT use proper escaping */
        dst = trc['is-dst'] ? '+' : '';
        return echo("\\paRight{" + x_position + "}{" + y_position + "}{" + (dst + this_time[0]) + " : " + this_time[1] + "}");
      };
    })(this));
  };

  if (module.parent == null) {
    this.main();
  }

}).call(this);
